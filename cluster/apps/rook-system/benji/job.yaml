---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: benji-configmap-refresher
  namespace: rook-ceph
spec:
  schedule: "0 15 * * *"
  jobTemplate:
    spec:
      backoffLimit: 0
      template:
        spec:
          serviceAccountName: rook-ceph-system
          containers:
            - name: configmap-refresher
              image: ghcr.io/k8s-at-home/kubectl:v1.22.3
              command:
                - "/bin/sh"
                - "-ec"
                - |
                  set -o nounset
                  set -o errexit

                  pod=$(kubectl get pod --selector app=rook-direct-mount --output custom-columns=:metadata.name --namespace rook-ceph)
                  conf=$(kubectl exec --namespace rook-ceph --stdin --tty $pod -- cat /etc/ceph/ceph.conf | grep mon_host | sed 's/[a-z0-9_-]\+=//g')
                  
                  configmap="benji-ceph-etc"
                  configmap_source_content=$(kubectl get configmap $configmap --namespace rook-ceph --output yaml)

                  test=$(echo $configmap_source_content | grep -q "$conf")

                  if [ $? -ne 0 ]; then
                      curl --location https://raw.githubusercontent.com/auricom/home-cluster/main/cluster/apps/rook-system/benji/configmap.yaml --output /tmp/configmap.yaml
                      # delete configmap
                      kubectl delete configmap $configmap --namespace rook-ceph
                      # create configmap
                      cat /tmp/configmap.yaml | sed -e "s/mon_host/`echo $conf`/g" > /tmp/ceph.conf
                      kubectl apply -f /tmp/ceph.conf
                  fi
          restartPolicy: OnFailure
