---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: &app recyclarr
  namespace: &namespace default
spec:
  interval: 15m
  chart:
    spec:
      chart: raw
      version: v0.3.1
      sourceRef:
        kind: HelmRepository
        name: dysnix
        namespace: flux-system
  install:
    createNamespace: true
    remediation:
      retries: 5
  upgrade:
    remediation:
      retries: 5
  dependsOn:
    - name: sonarr
      namespace: default
    - name: radarr
      namespace: default
  values:
    resources:
      - apiVersion: batch/v1
        kind: CronJob
        metadata:
          name: *app
          namespace: *namespace
        spec:
          schedule: "@daily"
          jobTemplate:
            spec:
              ttlSecondsAfterFinished: 86400
              template:
                spec:
                  automountServiceAccountToken: false
                  restartPolicy: OnFailure
                  initContainers:
                    - name: render-configs
                      image: ghcr.io/onedr0p/alpine:3.17.0
                      envFrom:
                        - secretRef:
                            name: *app
                      command:
                        - "/bin/bash"
                        - -c
                      args:
                        - "envsubst < /config/recyclarr.yml > /shared/recyclarr.yml"
                      volumeMounts:
                        - name: config
                          mountPath: /config
                        - name: shared
                          mountPath: /shared
                  containers:
                    - name: sonarr
                      image: ghcr.io/recyclarr/recyclarr:3.1.0
                      command:
                        - /app/recyclarr/recyclarr
                      args:
                        - sonarr
                      volumeMounts:
                        - name: shared
                          mountPath: /config/recyclarr.yml
                          subPath: recyclarr.yml
                          readOnly: true
                    - name: radarr
                      image: ghcr.io/recyclarr/recyclarr:3.1.0
                      command:
                        - /app/recyclarr/recyclarr
                      args:
                        - radarr
                      volumeMounts:
                        - name: shared
                          mountPath: /config/recyclarr.yml
                          subPath: recyclarr.yml
                          readOnly: true
                  volumes:
                    - name: config
                      configMap:
                        name: *app
                    - name: shared
                      emptyDir: {}
