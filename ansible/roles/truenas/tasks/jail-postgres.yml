---
- name: jail-postgres | get jail ip
  ansible.builtin.shell:
    cmd: iocage exec postgres ifconfig epair0b | grep 'inet' | awk -F ' ' '{ print $2 }'
  changed_when: false
  register: jail_ip
  become: true

# TODO : check if postgres already installed
# - block:
#     - name: jail-postgres | create zfs pools
#       community.general.zfs:
#         name: "{{ item }}"
#         state: present
#       loop:
#         - "{{ pool_name }}/jail-mounts"
#         - "{{ pool_name }}/jail-mounts/postgres"
#         - "{{ pool_name }}/jail-mounts/postgres/data{{ postgres_version }}"
#         - "{{ pool_name }}/jail-mounts/postgres/data{{ postgres_version }}/base"
#         - "{{ pool_name }}/jail-mounts/postgres/data{{ postgres_version }}/pg_wal"

#     - name: jail-postgres | configure zfs pool postgresql
#       community.general.zfs:
#         name: "{{ pool_name }}/jail-mounts/postgres"
#         state: present
#         extra_zfs_properties:
#           atime: off
#           setuid: off

#     - name: jail-postgres | configure zfs pool postgresql
#       community.general.zfs:
#         name: "{{ pool_name }}/jail-mounts/postgres"
#         state: present
#         extra_zfs_properties:
#           atime: off
#           setuid: off

#     - name: jail-postgres | create empty data{{ postgres_version }}dir
#       ansible.builtin.shell:
#         cmd: iocage exec postgres mkdir -p /var/db/postgres/data{{ postgres_version }}

#     - name: jail-postgres | mount data {{ postgres_version }}
#       ansible.builtin.shell:
#         cmd: iocage fstab -a postgres /mnt/{{ pool_name }}/jail-mounts/postgres/data{{ postgres_version }} /var/db/postgres/data{{ postgres_version }} nullfs rw 0 0
#       become: true

- block:
    - name: jail-postgres | packages
      community.general.pkgng:
        name:
          - postgresql{{ postgres_version }}-server
          - postgresql{{ postgres_version }}-contrib
          - postgresql{{ postgres_version }}-client
        state: present

    - name: jail-postgres | change postgres/data{{ postgres_version }} mod
      ansible.builtin.file:
        path: /var/db/postgres/data{{ postgres_version }}
        owner: postgres
        group: postgres

    - name: jail-postgres | initdb
      ansible.builtin.shell:
        cmd: su -m postgres -c 'initdb -E UTF-8 /var/db/postgres/data{{ postgres_version }}'

  delegate_to: "{{ jail_ip.stdout }}"
  remote_user: root
